
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Computing discrete Fourier transforms &#8212; Janus 0.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Square inclusion, basic scheme" href="tutorials/square_basic/square_basic.html" />
    <link rel="prev" title="Materials" href="materials.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="computing-discrete-fourier-transforms">
<span id="fft"></span><h1>Computing discrete Fourier transforms<a class="headerlink" href="#computing-discrete-fourier-transforms" title="Permalink to this headline">¶</a></h1>
<p>Discrete Fourier transforms are computed through the Fast Fourier Transform method (FFT) implemented in the <a class="reference external" href="http://www.fftw.org/">FFTW</a> library. Module <a class="reference internal" href="api.html#module-janus.fft" title="janus.fft"><code class="xref py py-mod docutils literal notranslate"><span class="pre">janus.fft</span></code></a> provides a Python wrapper to this C library. This module exposes both serial and parallel (MPI) implementations through a unified interface.</p>
<p>Before the main methods and functions of the <a class="reference internal" href="api.html#module-janus.fft" title="janus.fft"><code class="xref py py-mod docutils literal notranslate"><span class="pre">janus.fft</span></code></a> module are introduced, an important design issue should be mentioned. In the present implementation of the module, input data (to be transformed) is not passed directly to FFTW. Rather, a local copy is first made, and FFTW then operates on this local copy. This allows reusing the same plan to perform many transforms (which is advantageous in the context of iterative solvers). This certainly induces a performance hit, which is deemed negligible for transforms of large 2D or 3D arrays.</p>
<p>Although not essential, it might be useful to have a look to the <a class="reference external" href="http://www.fftw.org/fftw3_doc/">FFTW manual</a>. For the time being, only two and three dimensional real-to-complex transforms are implemented.</p>
<div class="section" id="serial-computations">
<h2>Serial computations<a class="headerlink" href="#serial-computations" title="Permalink to this headline">¶</a></h2>
<p>The following piece of code creates an object <code class="docutils literal notranslate"><span class="pre">transform</span></code> which can perform real FFTs on <code class="docutils literal notranslate"><span class="pre">32x64</span></code> grids of real numbers.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">janus.fft.serial</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transform</span> <span class="o">=</span> <span class="n">janus</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">create_real</span><span class="p">((</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">))</span>
</pre></div>
</div>
<p>The function <a class="reference internal" href="api.html#janus.fft.serial.create_real" title="janus.fft.serial.create_real"><code class="xref py py-func docutils literal notranslate"><span class="pre">janus.fft.serial.create_real()</span></code></a> can be passed planner flags (see <a class="reference external" href="http://www.fftw.org/fftw3_doc/Planner-Flags.html#Planner-Flags">Planner Flags</a> in the FFTW manual). The attributes of the returned object are</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">transform.global_ishape</span></code> contains the <em>global</em> shape of the input array,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">transform.ishape</span></code> contains the <em>local</em> shape of the input (real) array,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">transform.global_oshape</span></code> contains the <em>global</em> shape of the output (complex) array,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">transform.oshape</span></code> contains the <em>local</em> shape of the output (complex) array. For serial transforms, local and global output shapes coincide.</p></li>
</ul>
</div></blockquote>
<p>For serial transforms, local and global shapes coincide.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">transform</span><span class="o">.</span><span class="n">global_ishape</span>
<span class="go">(32, 64)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transform</span><span class="o">.</span><span class="n">ishape</span>
<span class="go">(32, 64)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transform</span><span class="o">.</span><span class="n">global_oshape</span>
<span class="go">(32, 66)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">transform</span><span class="o">.</span><span class="n">oshape</span>
<span class="go">(32, 66)</span>
</pre></div>
</div>
<p>It should be noted that complex-valued tables are stored according to the FFTW library: even (resp. odd) values of the fast index correspond to the real (resp. imaginary) part of the complex number (see also <a class="reference external" href="http://www.fftw.org/fftw3_doc/Multi_002dDimensional-DFTs-of-Real-Data.html#Multi_002dDimensional-DFTs-of-Real-Data">Multi-Dimensional DFTs of Real Data</a> in the FFTW manual).</p>
<p>Direct (real-to-complex) transforms are computed through the method <code class="docutils literal notranslate"><span class="pre">transform.r2c()</span></code>, which takes as input a <code class="docutils literal notranslate"><span class="pre">MemoryView</span></code> of shape <code class="docutils literal notranslate"><span class="pre">transform.ishape</span></code>, and returns a <code class="docutils literal notranslate"><span class="pre">MemoryView</span></code> of shape <code class="docutils literal notranslate"><span class="pre">transform.oshape</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">20150223</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">transform</span><span class="o">.</span><span class="n">ishape</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y1</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">r2c</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>It should be noted that <code class="docutils literal notranslate"><span class="pre">y1</span></code> is a <code class="docutils literal notranslate"><span class="pre">MemoryView</span></code>, not a <code class="docutils literal notranslate"><span class="pre">numpy</span></code> array; it can, however, readily be converted into an array</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
<span class="go">&lt;MemoryView of &#39;array&#39; object&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">type</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
<span class="go">&lt;class &#39;numpy.ndarray&#39;&gt;</span>
</pre></div>
</div>
<p>The output can be converted to an array of complex numbers</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">actual</span> <span class="o">=</span> <span class="n">y1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">y1</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">actual</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(32, 33)</span>
</pre></div>
</div>
<p>and compared to the FFT of <code class="docutils literal notranslate"><span class="pre">x</span></code> computed by means of the <code class="docutils literal notranslate"><span class="pre">numpy.fft</span></code> module</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfftn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">expected</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(32, 33)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">abs_delta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">actual</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">abs_exp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">expected</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">abs_delta</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">abs_exp</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="mf">1E-15</span>
</pre></div>
</div>
<p>Inverse discrete Fourier transform is computed through the method <code class="docutils literal notranslate"><span class="pre">transform.c2r()</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x1</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">c2r</span><span class="p">(</span><span class="n">y1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">error</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x1</span> <span class="o">-</span> <span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">error</span> <span class="o">&lt;</span> <span class="mf">1E-15</span>
</pre></div>
</div>
<p>It should be noted that the output array can be passed as an argument to both <code class="docutils literal notranslate"><span class="pre">transform.r2c()</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">oshape</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">out</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">r2c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">out</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">y2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y2</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span>
</pre></div>
</div>
<p>and <code class="docutils literal notranslate"><span class="pre">transform.c2r()</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">ishape</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">out</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">c2r</span><span class="p">(</span><span class="n">y1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">out</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">x2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">x2</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span>
</pre></div>
</div>
</div>
<div class="section" id="parallel-computations">
<h2>Parallel computations<a class="headerlink" href="#parallel-computations" title="Permalink to this headline">¶</a></h2>
<p>The module <code class="xref py py-mod docutils literal notranslate"><span class="pre">janus.fft.parallel</span></code> is a wrapper around the <code class="docutils literal notranslate"><span class="pre">fftw3-mpi</span></code> library (refer to <a class="reference external" href="http://www.fftw.org/fftw3_doc/Distributed_002dmemory-FFTW-with-MPI.html#Distributed_002dmemory-FFTW-with-MPI">Distributed-memory FFTW with MPI</a> in the FFTW manual for the inner workings of this library). This module must be used along with the <a class="reference external" href="https://bitbucket.org/mpi4py/mpi4py">mpi4py</a> module to handle MPI communications.</p>
<p>The Python API is very similar to the API for serial transforms. However, computing a parallel FFT is slightly more involved than computing a serial FFT, because the data must be distributed across the processes. The computation must go through the following steps</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>create input data (root process),</p></li>
<li><p>create a transform object (all processes),</p></li>
<li><p>gather local shapes (root process),</p></li>
<li><p>scatter the input data according to the previouly gathered local sizes (root process),</p></li>
<li><p>compute the transform (all processes),</p></li>
<li><p>gather the results (root process).</p></li>
</ol>
</div></blockquote>
<p>This is illustrated in the step-by-step tutorial below. This tutorial aims again at computing a <code class="docutils literal notranslate"><span class="pre">32x64</span></code> real Fourier transform. The full source can be <a class="reference download internal" download="" href="_downloads/08b400a1670107f795ad6de84866f518/parallel_fft_tutorial.py"><code class="xref download docutils literal notranslate"><span class="pre">downloaded</span> <span class="pre">here</span></code></a>, it must be run through the following command line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mpiexec -np 2 python3 parallel_fft_tutorial.py
</pre></div>
</div>
<p>where the number of processes can be adjusted (all output produced below was obtained with two parallel processes).</p>
<p>Before we proceed with the description of the program, it should be noted that communication will be carried out with the uppercase versions <cite>MPI.Comm.Gather</cite> and <cite>MPI.Comm.Scatter</cite>. The lowercase versions of <cite>MPI.Comm.scatter</cite> and <cite>MPI.Comm.gather</cite> are slightly easier to use, but communicate objects through pickling. This approach fails with very large objects (the size limit is much lower than the intrinsic MPI size limit). With <cite>MPI.Comm.Gather</cite> and <cite>MPI.Comm.Scatter</cite>, the intrinsic MPI size limit is restored. The FFT objects defined in the module <code class="xref py py-mod docutils literal notranslate"><span class="pre">janus.fft.parallel</span></code> provide attributes to help call these methods.</p>
<p>A few modules must first be imported</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">janus.fft.parallel</span>

<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>

</pre></div>
</div>
<p>Then, some useful variables are created</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="n">root</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
</pre></div>
</div>
<p>Then, the transform objects (one for each process) are created (step 2), and their various shapes are printed out.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">transform</span> <span class="o">=</span> <span class="n">janus</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">create_real</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">comm</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;global_ishape  = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">global_ishape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;global_oshape  = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">global_oshape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ishape = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">ishape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;oshape = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">oshape</span><span class="p">))</span>
</pre></div>
</div>
<p>This code snippet outputs the following messages</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>global_ishape  = (32, 64)
global_oshape  = (32, 66)
ishape = (16, 64)
oshape = (16, 66)
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">transform.shape</span></code> attribute refers to the <em>global</em> (logical) shape of the transform. Since the data is distributed across all processes, the <em>local</em> size in memory of the input and output data differ from <code class="docutils literal notranslate"><span class="pre">transform.shape</span></code>. Accordingly, the <code class="docutils literal notranslate"><span class="pre">transform.rshape</span></code> (resp. <code class="docutils literal notranslate"><span class="pre">transform.cshape</span></code>) attribute refers to the local shape of the real, input (resp. complex, output) data, for the current process. As expected with FFTW, it is observed that the data is distributed with respect to the first dimension. Indeed, the global, first dimension is 64, and the above example is run with 2 processes; therefore, the local first dimension is <code class="docutils literal notranslate"><span class="pre">64</span> <span class="pre">/</span> <span class="pre">2</span> <span class="pre">=</span> <span class="pre">32</span></code>.</p>
<p>In order to figure out how to scatter the input data, the root process then gathers all local sizes and displacements, and the parameters to be passed to <code class="docutils literal notranslate"><span class="pre">mpi4py.MPI.Scatterv()</span></code> and <code class="docutils literal notranslate"><span class="pre">mpi4py.MPI.Gatherv()</span></code> are prepared</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">counts_and_displs</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sendobj</span><span class="o">=</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">isize</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">idispl</span><span class="p">,</span>
                                             <span class="n">transform</span><span class="o">.</span><span class="n">osize</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">odispl</span><span class="p">),</span>
                                    <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">20150310</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">icounts</span><span class="p">,</span> <span class="n">idispls</span><span class="p">,</span> <span class="n">ocounts</span><span class="p">,</span> <span class="n">odispls</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">counts_and_displs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">icounts</span><span class="p">,</span> <span class="n">idispls</span><span class="p">,</span> <span class="n">ocounts</span><span class="p">,</span> <span class="n">odispls</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
</pre></div>
</div>
<p>Then the input data <code class="docutils literal notranslate"><span class="pre">x</span></code> is scattered across all processes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">x_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">ishape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Scatterv</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">icounts</span><span class="p">,</span> <span class="n">idispls</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">],</span> <span class="n">x_loc</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
</pre></div>
</div>
<p>Each process then executes its transform</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">y_loc</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">r2c</span><span class="p">(</span><span class="n">x_loc</span><span class="p">)</span>
</pre></div>
</div>
<p>and the root process finally gathers the results</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">global_oshape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Gatherv</span><span class="p">(</span><span class="n">y_loc</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">ocounts</span><span class="p">,</span> <span class="n">odispls</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">],</span> <span class="n">root</span><span class="p">)</span>
</pre></div>
</div>
<p>To check that the computation is correct, the same transform is finally computed locally by the root process</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">serial_transform</span> <span class="o">=</span> <span class="n">janus</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">create_real</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">y_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">serial_transform</span><span class="o">.</span><span class="n">r2c</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">y_ref</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_ref</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
</pre></div>
</div>
<div class="section" id="the-complete-program">
<h3>The complete program<a class="headerlink" href="#the-complete-program" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Imports</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">janus.fft.parallel</span>

<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="k">import</span> <span class="n">MPI</span>

<span class="c1"># Init some variables</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
    <span class="n">root</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
    <span class="c1"># Create transform objects</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="n">janus</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">parallel</span><span class="o">.</span><span class="n">create_real</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">comm</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;global_ishape  = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">global_ishape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;global_oshape  = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">global_oshape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ishape = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">ishape</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;oshape = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">oshape</span><span class="p">))</span>
    <span class="c1"># Prepare communications</span>
    <span class="n">counts_and_displs</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">sendobj</span><span class="o">=</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">isize</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">idispl</span><span class="p">,</span>
                                             <span class="n">transform</span><span class="o">.</span><span class="n">osize</span><span class="p">,</span> <span class="n">transform</span><span class="o">.</span><span class="n">odispl</span><span class="p">),</span>
                                    <span class="n">root</span><span class="o">=</span><span class="n">root</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">20150310</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="o">*</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">icounts</span><span class="p">,</span> <span class="n">idispls</span><span class="p">,</span> <span class="n">ocounts</span><span class="p">,</span> <span class="n">odispls</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">counts_and_displs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">icounts</span><span class="p">,</span> <span class="n">idispls</span><span class="p">,</span> <span class="n">ocounts</span><span class="p">,</span> <span class="n">odispls</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="c1"># Scatter input data</span>
    <span class="n">x_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">ishape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Scatterv</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">icounts</span><span class="p">,</span> <span class="n">idispls</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">],</span> <span class="n">x_loc</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
    <span class="c1"># Execute transform</span>
    <span class="n">y_loc</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">r2c</span><span class="p">(</span><span class="n">x_loc</span><span class="p">)</span>
    <span class="c1"># Gather output data</span>
    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">global_oshape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">comm</span><span class="o">.</span><span class="n">Gatherv</span><span class="p">(</span><span class="n">y_loc</span><span class="p">,</span> <span class="p">[</span><span class="n">y</span><span class="p">,</span> <span class="n">ocounts</span><span class="p">,</span> <span class="n">odispls</span><span class="p">,</span> <span class="n">MPI</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">],</span> <span class="n">root</span><span class="p">)</span>
    <span class="c1"># Validate result</span>
    <span class="k">if</span> <span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="n">root</span><span class="p">:</span>
        <span class="n">serial_transform</span> <span class="o">=</span> <span class="n">janus</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">serial</span><span class="o">.</span><span class="n">create_real</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">y_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">serial_transform</span><span class="o">.</span><span class="n">r2c</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">y_ref</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_ref</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">err</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">eps</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/logo_janus-200x200.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="index.html">Janus</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="operators.html">Operators</a></li>
<li class="toctree-l1"><a class="reference internal" href="materials.html">Materials</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Computing discrete Fourier transforms</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#serial-computations">Serial computations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#parallel-computations">Parallel computations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tutorials/square_basic/square_basic.html">Square inclusion, basic scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="todo.html">TODO List</a></li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="mandel.html">Mandel notation</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="materials.html" title="previous chapter">Materials</a></li>
      <li>Next: <a href="tutorials/square_basic/square_basic.html" title="next chapter">Square inclusion, basic scheme</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2013-2018, S. Brisard.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.1.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/fft_tutorial.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>